name: "Container Security Scan"
description: "Scans container images for vulnerabilities using Lacework"

inputs:
  image-name:
    required: false
    description: "Docker image name"
  image-tag:
    required: true
    description: "Docker image tag"
  enable-docker-build:
    required: false
    default: "true"
    description: "Enable Docker build"
  build-args:
    required: false
    description: "Docker build arguments"
  lw-account-name:
    required: true
    description: "Lacework account name"
  lw-access-token:
    required: true
    description: "Lacework access token"

outputs:
  scan-results-path:
    description: "Path to the scan results file"
    value: ${{ steps.scan.outputs.results-file }}

runs:
  using: composite
  steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Build docker image
      if: ${{ inputs.enable-docker-build }}
      uses: open-turo/actions-security/docker-build@v3
      id: docker-build
      with:
        dockerhub-user: ${{ inputs.dockerhub-user }}
        dockerhub-password: ${{ inputs.dockerhub-password }}
        image-version: ${{ inputs.image-tag }}
        build-args: ${{ inputs.build-args }}

    - name: Determine Image Name
      run: |
        if [ "${{ inputs.enable-docker-build }}" = "true" ]; then
          echo "IMAGE_NAME=${{ steps.docker-build.outputs.image-name }}" >> $GITHUB_ENV
        else
          echo "IMAGE_NAME=${{ inputs.image-name }}" >> $GITHUB_ENV
        fi
      shell: bash

    - name: Scan Container Image
      id: scan
      uses: lacework/lw-scanner-action@v1.4.3
      with:
        LW_ACCOUNT_NAME: ${{ inputs.lw-account-name }}
        LW_ACCESS_TOKEN: ${{ inputs.lw-access-token }}
        IMAGE_NAME: ${{ env.IMAGE_NAME }}
        IMAGE_TAG: ${{ inputs.image-tag }}
        SAVE_RESULTS_IN_LACEWORK: true
        ADDITIONAL_PARAMETERS: "-j"

    - name: Cleanup Docker Image
      if: always()
      run: |
        if [[ -n "${IMAGE_NAME}" ]]; then
          docker image rm "${IMAGE_NAME}:${{ inputs.image-tag }}" || true
        fi
      shell: bash
