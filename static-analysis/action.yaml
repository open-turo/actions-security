name: Run static code analysis
description: GitHub Action that scans code changes being made and posts security findings as comments on pull requests.
inputs:
  semgrep-app-token:
    required: true
    description: Semgrep API token to pull the latest rule configuration from the ruleboard in Semgrep UI.
runs:
  using: composite
  steps:
    - uses: open-turo/action-setup-tools@v2
      with:
        python: 3.10.12

    - uses: actions/checkout@v4
      with:
        fetch-depth: 2

    - name: Run Semgrep
      run: |
        SEMGREP_APP_TOKEN="${{ inputs.semgrep-app-token }}" pipx run --spec semgrep==1.101.0 semgrep ci
      shell: bash

    - name: List Semgrep Installation Folders
      run: |
        echo "=== pipx list output ==="
        pipx list
        echo ""

        echo "=== Checking ~/.semgrep directory ==="
        if [ -d ~/.semgrep ]; then
          echo "Contents of ~/.semgrep directory:"
          ls -la ~/.semgrep
        else
          echo "~/.semgrep directory does not exist."
        fi

        echo ""
        echo "=== Checking pipx cache and semgrep binary location ==="
        if [ -d ~/.local/pipx ]; then
          echo "Contents of ~/.local/pipx:"
          ls -R ~/.local/pipx
        else
          echo "~/.local/pipx directory does not exist."
        fi
      shell: bash

    - name: Cleanup Semgrep Environment
      run: |
        echo "Cleaning up Semgrep environment..."

        # Remove Semgrep virtual environment
        if [ -d ~/.local/pipx/venvs/semgrep ]; then
          echo "Removing Semgrep virtual environment..."
          rm -rf ~/.local/pipx/venvs/semgrep
        fi

        # Remove pipx cache
        if [ -d ~/.local/pipx/cache ]; then
          echo "Removing pipx cache..."
          rm -rf ~/.local/pipx/cache
        fi

        # Remove Semgrep runtime files
        if [ -d ~/.semgrep ]; then
          echo "Removing Semgrep runtime files..."
          rm -rf ~/.semgrep
        fi

        echo "Semgrep environment cleanup completed."
      shell: bash
